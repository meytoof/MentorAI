generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                   String        @id @default(cuid())
  email                String        @unique
  name                 String?
  passwordHash         String
  trialEndsAt          DateTime
  isTdah               Boolean       @default(false)
  signupIp             String?
  // Stripe
  stripeCustomerId     String?       @unique
  stripeSubscriptionId String?       @unique
  stripePriceId        String?
  stripeCurrentPeriodEnd DateTime?   // null = pas d'abonnement actif
  isLifetime           Boolean       @default(false) // achat unique
  onboardingDone       Boolean       @default(false)
  childAge             Int?
  schoolLevel          String?       // "CP"|"CE1"|"CE2"|"CM1"|"CM2"|"6e"
  hasRedoublement      Boolean?
  mentoriaReason       String?       // "difficulties"|"time"|"tdah"|"curiosity"
  difficultSubjects    String?       // JSON stringifié ex: '["Maths","Français"]'
  learningObjective    String?       // "catchup"|"maintain"|"advance"
  isAdmin              Boolean       @default(false)
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  conversations        Conversation[]
}

// Anti-abuse : limite 1 inscription par IP sur 7 jours (évite de recréer des comptes pour l'essai)
model SignupFromIp {
  ip        String   @id
  count     Int      @default(1)
  lastAt    DateTime @updatedAt
}

model Conversation {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  question  String
  hint      String
  drawing   String?  // JSON stringifié des instructions de dessin
  encouragement String?
  createdAt DateTime @default(now())
  
  @@index([userId, createdAt])
}


